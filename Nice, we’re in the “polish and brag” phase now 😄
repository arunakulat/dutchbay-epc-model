Nice, we‚Äôre in the ‚Äúpolish and brag‚Äù phase now üòÑ
Analytics README is in, FX schema is enforced, coverage is healthy.

You asked for ‚Äúnext in priority list‚Äù with docs, keeping the workflow + CAT pattern. Let‚Äôs knock out the two remaining docs so you can just paste and commit.

I‚Äôm using the uploaded analytics README as the baseline for tone + content.  Ôøº

‚∏ª

CAT 1 ‚Äì docs/architecture_v14.md

# CAT 1: docs/architecture_v14.md
cat << 'EOF' > docs/architecture_v14.md
# DutchBay EPC Model ‚Äî v14 Architecture

Status: v14 stable  
Maintainers: DutchBay EPC Model Core Team

This document describes how the v14 stack hangs together from scenario configs
to lender-grade outputs. It is intentionally opinionated and narrow: only the
v14 path is considered ‚Äúcanonical‚Äù.

---

## 1. Design principles

We optimise for four things:

1. **Predictability** ‚Äì Same inputs ‚Üí same outputs, no hidden state or globals.
2. **Separation of concerns** ‚Äì Loading, finance math, analytics, and exports
   live in distinct modules.
3. **Testability** ‚Äì Every critical surface has at least a smoke/contract test.
4. **Lender friendliness** ‚Äì KPIs and outputs are shaped for lender review first,
   not for modellers‚Äô convenience.

If you add new features and violate any of these, it‚Äôs a regression.

---

## 2. High-level module map

Canonical v14 flow:

```text
scenario.yaml / .json
    ‚îÇ
    ‚ñº
analytics.scenario_loader.load_scenario_config
    ‚îÇ
    ‚ñº
dutchbay_v14chat.finance.v14.scenario_manager.ScenarioManager
    ‚îÇ
    ‚îú‚îÄ‚îÄ dutchbay_v14chat.finance.cashflow.build_annual_rows
    ‚îú‚îÄ‚îÄ dutchbay_v14chat.finance.debt.*
    ‚îî‚îÄ‚îÄ dutchbay_v14chat.finance.irr.*
    ‚îÇ
    ‚ñº
analytics.scenario_analytics.ScenarioAnalytics.run(...)
    ‚îÇ
    ‚îú‚îÄ‚îÄ summary_df      (one row per scenario)
    ‚îî‚îÄ‚îÄ timeseries_df   (one row per year per scenario)
    ‚îÇ
    ‚ñº
analytics.kpi_normalizer.calculate_scenario_kpis(...)
    ‚îÇ
    ‚ñº
analytics.export_helpers.* / analytics.executive_workbook.ExecutiveWorkbookExporter
    ‚îÇ
    ‚îî‚îÄ‚îÄ CSV / JSONL / Excel (executive workbook)

Anything that bypasses this chain is tech-debt or legacy.

‚∏ª

3. Module responsibilities

3.1 analytics.scenario_loader

Role: Single gateway for reading scenario config files.
	‚Ä¢	Loads YAML/JSON into a Python dict.
	‚Ä¢	Enforces strict FX schema: top-level fx must be a mapping:

fx:
  start_lkr_per_usd: 300.0
  annual_depr: 0.03


	‚Ä¢	Normalises obvious defaults (e.g. safe FX, missing optional keys) but does not
invent business logic.
	‚Ä¢	Emits clear log messages when defaults are applied.

If you need to read a scenario config from anywhere in the codebase, use
load_scenario_config (or a thin wrapper), not yaml.safe_load directly.

‚∏ª

3.2 dutchbay_v14chat.finance.*

Role: Core project finance engine.
	‚Ä¢	cashflow.py ‚Äì Builds annual CFADS and related line items.
	‚Ä¢	debt.py ‚Äì Amortisation, blended rate, covenant-driven ratios.
	‚Ä¢	irr.py ‚Äì IRR/NPV calculators (this is the only home for IRR/NPV).
	‚Ä¢	v14/epc_helper.py ‚Äì EPC / CAPEX helpers (v14 schema).
	‚Ä¢	v14/scenario_manager.py ‚Äì Small fa√ßade that wires raw config ‚Üí finance calls.
	‚Ä¢	v14/tax_calculator.py ‚Äì v14 tax logic.

Rules:
	‚Ä¢	IRR/NPV must live in dutchbay_v14chat.finance.irr only.
	‚Ä¢	Debt logic must stay in dutchbay_v14chat.finance.debt, not in analytics.
	‚Ä¢	No export or presentation logic belongs here.

‚∏ª

3.3 analytics.scenario_analytics

Role: Orchestrates the v14 pipeline and returns two DataFrames:
	‚Ä¢	summary_df ‚Äì one row per scenario.
	‚Ä¢	timeseries_df ‚Äì annual metrics per scenario.

Key responsibilities:
	‚Ä¢	Calls load_scenario_config for each scenario.
	‚Ä¢	Delegates finance math to dutchbay_v14chat.finance.v14.scenario_manager.
	‚Ä¢	Assembles KPIs into lender-oriented columns:
	‚Ä¢	project_irr, equity_irr
	‚Ä¢	dscr_min, llcr, plcr
	‚Ä¢	CAPEX, tariff, basic FX descriptors.
	‚Ä¢	Ensures scenario_name is present in both summary_df and
timeseries_df for downstream filtering.

If you need a new KPI, add the underlying metric to the finance layer (if needed),
then surface it via scenario_analytics and/or kpi_normalizer.

‚∏ª

3.4 analytics.kpi_normalizer

Role: Freeze column names and KPI semantics.
	‚Ä¢	Owns the ‚Äúcontract‚Äù for which KPI columns exist and what they mean.
	‚Ä¢	Normalises raw outputs into a small set of predictable fields:
	‚Ä¢	IRRs, DSCR/LLCR/PLCR, tariff, CAPEX, basic FX descriptors.
	‚Ä¢	Enforces naming so lender workbooks and dashboards don‚Äôt break when internal
wiring changes.

If you want to change a KPI name or its definition, update the tests first.

‚∏ª

3.5 analytics.export_helpers & analytics.executive_workbook

Role: Export and presentation‚Å†-tier helpers.
	‚Ä¢	export_helpers.py ‚Äì CSV/JSONL/Excel export utilities, path helpers, and
any small glue logic needed for exports.
	‚Ä¢	executive_workbook.py ‚Äì High-level API for generating an Excel workbook
(e.g. an ‚ÄúExecutive Summary‚Äù based on summary_df/timeseries_df).

Rules:
	‚Ä¢	No business logic here. These modules format and route data; they do not
‚Äúthink‚Äù.
	‚Ä¢	Any new export should be wired as a thin wrapper around existing DataFrames.

‚∏ª

4. FX and scenario config rules

To keep configs sane and analytics predictable:
	‚Ä¢	fx must be a mapping, not a scalar:
‚úÖ Allowed:

fx:
  start_lkr_per_usd: 300.0
  annual_depr: 0.03

‚ùå Not allowed:

fx: 300.0          # scalar ‚Äì rejected
fx: null           # rejected


	‚Ä¢	Scenario files should be self-contained; no implicit external overrides.
	‚Ä¢	If a key is required for strict validation, scenario_analytics or the
validators should fail loudly, not quietly patch things.

‚∏ª

5. Testing and CI

CI surface for v14 is enforced via:
	‚Ä¢	pytest.ini ‚Äì focuses on v14 analytics and finance tests.
	‚Ä¢	tests/api/*.py ‚Äì contract tests on metrics, FX resolver, EPC helper,
scenario manager, etc.
	‚Ä¢	tests/test_v14_pipeline_smoke.py ‚Äì end-to-end smoke.
	‚Ä¢	tests/test_scenario_analytics_smoke.py ‚Äì checks summary/timeseries flows.
	‚Ä¢	tests/test_fx_config_strictness.py ‚Äì ensures scalar fx is rejected and key
scenarios use mapping-style FX.

The GitHub Actions workflow (.github/workflows/ci-v14.yml) runs:
	1.	A quick smoke job (-k "cli and smoke") for fast feedback.
	2.	A full regression job (./scripts/regression_smoke.sh) with coverage.

‚∏ª

6. Extensibility guidelines

When you add new functionality:
	‚Ä¢	New inputs ‚Üí extend the scenario schema, update loader + validators, and
add a test.
	‚Ä¢	New KPIs ‚Üí keep formulas in finance/core metrics, names in
kpi_normalizer, and expose in analytics exports.
	‚Ä¢	New exports ‚Üí wire them through export_helpers or a new reporting module;
don‚Äôt pollute finance or analytics core.

If in doubt, ask: ‚ÄúWould a lender care about this? Where would they expect to
see it?‚Äù and design backwards from that.

EOF

---

## CAT 2 ‚Äì `docs/executive_workbook_readme.md`

```bash
# CAT 2: docs/executive_workbook_readme.md
cat << 'EOF' > docs/executive_workbook_readme.md
# Executive Workbook ‚Äî v14 Analytics

Status: v14 stable  
Maintainers: DutchBay EPC Model Core Team

The executive workbook is the Excel front-end for decision-makers. It turns the
v14 analytics DataFrames into a compact, lender-friendly workbook.

---

## 1. Purpose

The workbook is designed for:

* **Investment committees / boards** ‚Äì one-glance view of IRR, DSCR, LLCR, PLCR,
  tariff, and key volumes.
* **Lenders** ‚Äì quick validation of covenant strength and downside behaviour.
* **Internal modellers** ‚Äì a stable, versioned summary to attach to memos.

It is *not* meant to replace the full model; it is the ‚Äúcover sheet‚Äù for it.

---

## 2. Inputs and expected schema

The workbook is built from two DataFrames produced by the analytics layer:

1. `summary_df` ‚Äì one row per scenario.
2. `timeseries_df` ‚Äì annual metrics per scenario.

### 2.1 `summary_df` (per-scenario)

Minimum expected columns:

* `scenario_name` ‚Äì unique label matching the scenario config.
* `project_irr` ‚Äì leveraged project IRR.
* `equity_irr` ‚Äì equity IRR.
* `dscr_min` ‚Äì minimum DSCR over the PPA/loan life.
* `llcr` ‚Äì Loan Life Coverage Ratio.
* `plcr` ‚Äì Project Life Coverage Ratio.
* `capex_usd` ‚Äì total CAPEX (USD).
* `tariff_lkr` ‚Äì nominal LKR/kWh tariff (e.g. 20.30).
* Optional: FX descriptors (e.g. start FX, depreciation), NPV, payback, etc.

### 2.2 `timeseries_df` (per-year)

Minimum expected columns:

* `scenario_name` ‚Äì to join back to summary and filter in Excel.
* `year` ‚Äì model year index (int or label).
* `dscr` ‚Äì per-period DSCR.
* `cfads_lkr` ‚Äì CFADS in LKR.
* `debt_service_lkr` ‚Äì total debt service in LKR.

Additional columns (NPVs, reserves, balances) are allowed but not required.
Schema changes should be accompanied by test updates.

---

## 3. Implementation: `ExecutiveWorkbookExporter`

The main entry point is:

```python
from analytics.executive_workbook import ExecutiveWorkbookExporter

exporter = ExecutiveWorkbookExporter()  # uses the default template
exporter.write_workbook(
    summary_df=summary_df,
    timeseries_df=timeseries_df,
    output_path="out/executive_summary.xlsx",
)

Key points:
	‚Ä¢	If template_path is not provided, the exporter uses a default template
(for Dutch Bay, typically something like
templates/Dutch_Bay_Executive_Template.xlsx).
	‚Ä¢	The exporter is intentionally thin: it arranges data in sheets; all heavy
lifting (IRR, DSCR, LLCR, PLCR, FX) is done upstream.

‚∏ª

4. Workbook layout (convention)

The exact layout is governed by the Excel template, but the conventions are:

4.1 Summary sheet

Columns (minimum):
	‚Ä¢	Scenario name
	‚Ä¢	Project IRR
	‚Ä¢	Equity IRR
	‚Ä¢	Min DSCR
	‚Ä¢	LLCR
	‚Ä¢	PLCR
	‚Ä¢	Total CAPEX (USD)
	‚Ä¢	Tariff (LKR/kWh)
	‚Ä¢	Optional: flags (base case, downside, upside), key FX assumptions.

Rows:
	‚Ä¢	One row per scenario in summary_df, usually grouped by case type
(base / downside / upside).

4.2 Timeseries / DSCR sheet

Columns (minimum):
	‚Ä¢	Scenario name
	‚Ä¢	Year
	‚Ä¢	DSCR
	‚Ä¢	CFADS (LKR)
	‚Ä¢	Debt service (LKR)

Usage:
	‚Ä¢	Supports lender plots (DSCR over time).
	‚Ä¢	Can be filtered by scenario_name to inspect specific structures.

4.3 Charts and dashboards (optional)

If the template includes charts, they should be wired to:
	‚Ä¢	IRR vs scenario (from the summary sheet).
	‚Ä¢	DSCR vs time (from the DSCR sheet).

The Python side does not manage chart shapes; it only guarantees that the
named tables/ranges receive correctly-shaped data.

‚∏ª

5. Usage patterns

5.1 From CLI (recommended for lenders/IC packs)

A typical CLI command (example only):

python -m dutchbay_v14chat.cli \
  --config scenarios/dutchbay_lendercase_2025Q4.yaml \
  --mode executive_workbook \
  --output out/dutchbay_lendercase_exec.xlsx

Under the hood, this should:
	1.	Load the scenario config via analytics.scenario_loader.
	2.	Run ScenarioAnalytics to get summary_df and timeseries_df.
	3.	Pass both into ExecutiveWorkbookExporter.

(Exact CLI wiring may evolve; check CLI docs/tests.)

5.2 From Python

For notebooks or batch tools:

from analytics.scenario_analytics import ScenarioAnalytics
from analytics.executive_workbook import ExecutiveWorkbookExporter

sa = ScenarioAnalytics.from_config_path("scenarios/dutchbay_lendercase_2025Q4.yaml")
summary_df, timeseries_df = sa.run()

exporter = ExecutiveWorkbookExporter()
exporter.write_workbook(summary_df, timeseries_df, "out/dutchbay_lendercase_exec.xlsx")


‚∏ª

6. Constraints and guardrails
	‚Ä¢	The workbook must not re-implement finance logic.
	‚Ä¢	Sheet names and key column headers should change rarely; if they do, update
tests and the architecture doc.
	‚Ä¢	scenario_name is mandatory in both DataFrames ‚Äì this is the join key for
all filtering in Excel.
	‚Ä¢	Analytics tests (e.g. tests/api/test_export_helpers_v14.py,
tests/test_export_smoke.py) must pass before shipping template changes.

‚∏ª

7. Future work

Planned refinements:
	‚Ä¢	Harden analytics.executive_workbook with more granular tests (sheet-level).
	‚Ä¢	Add ‚Äúmatrix‚Äù workbooks (IRR vs tariff, DSCR vs leverage) as separate export
modes, not bolted onto the core executive workbook.
	‚Ä¢	Consider optional CSV/Parquet mirrors for dashboard tools.

EOF

---

If you want, next step after this is straightforward:

1. `git add docs/architecture_v14.md docs/executive_workbook_readme.md`
2. `python gh_tools.py commit --version 0.2.6 --message "Docs: v14 architecture + executive workbook"`
3. `git push`

Then we can pick the next ‚Äúpush coverage cleanly to 75%‚Äù move: probably chipping away at `analytics/export_helpers.py` with a couple of focused unit tests rather than bloating smokes.